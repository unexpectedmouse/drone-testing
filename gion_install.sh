#!/bin/bash
set -e
cd "$(dirname "$0")"

export LC_ALL=C.UTF-8
export LANG=C.UTF-8

if [ "$EUID" -ne 0 ]; then
  echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ sudo."
  exit 1
fi

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
install_package() {
  local package=$1
  if dpkg -s "$package" &>/dev/null; then
    echo "âœ… $package ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½."
  else
    echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ $package..."
    apt update
    apt install -y "$package"
  fi
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
install_package python3-dev
install_package git

REAL_USER=$(logname)
REAL_HOME=$(eval echo "~$REAL_USER")
REAL_PATH="$REAL_HOME/.local/bin:$PATH"

echo "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $REAL_USER"
echo "Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $REAL_HOME"

INSTALL_DIR="$REAL_HOME/gion"
VENV_DIR="$INSTALL_DIR/.venv"
RUN_SCRIPT_PATH="/usr/local/bin/gion-run.sh"


# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð´Ð»Ñ Git
echo "ðŸ”’ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Git..."
sudo -u "$REAL_USER" git config --global --add safe.directory "$INSTALL_DIR"

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
if [ -d "$INSTALL_DIR" ]; then
    echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
    cd "$INSTALL_DIR"

    # Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð½Ð° main
    sudo -u "$REAL_USER" git reset --hard
    sudo -u "$REAL_USER" git clean -fd
    sudo -u "$REAL_USER" git checkout main
    sudo -u "$REAL_USER" git pull --rebase

    # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
    chown -R "$REAL_USER:$REAL_USER" .
    cd ..
else
    echo "â¬ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
    sudo -u "$REAL_USER" git clone https://github.com/OnisOris/gion
    chown -R "$REAL_USER:$REAL_USER" "$INSTALL_DIR"
fi

if sudo -u "$REAL_USER" env PATH="$REAL_PATH" bash -c 'command -v uv &>/dev/null'; then
    echo "âœ… uv ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ."
else
    echo "ðŸ”§ uv Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ..."
    sudo -u "$REAL_USER" bash -c 'curl -LsSf https://astral.sh/uv/install.sh | sh'
fi

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ -d "$VENV_DIR" ]; then
    echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
    rm -rf "$VENV_DIR"
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸
mkdir -p "$VENV_DIR"
chown -R "$REAL_USER:$REAL_USER" "$VENV_DIR"

echo "ðŸ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
sudo -u "$REAL_USER" env PATH="$REAL_PATH" bash -c "\"$REAL_HOME/.local/bin/uv\" venv --python \"$PYTHON_BIN\" --prompt pion \"$VENV_DIR\""

echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
sudo -u "$REAL_USER" env PATH="$REAL_PATH" bash -c "source \"$VENV_DIR/bin/activate\" && \"$REAL_HOME/.local/bin/uv\" pip install setuptools wheel Cython numpy"

echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ pionsdk..."
sudo -u "$REAL_USER" env PATH="$REAL_PATH" bash -c "source \"$VENV_DIR/bin/activate\" && \"$REAL_HOME/.local/bin/uv\" pip install \"git+https://github.com/OnisOris/pion.git@dev\""

echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ gion..."
sudo -u "$REAL_USER" env PATH="$REAL_PATH" bash -c "source \"$VENV_DIR/bin/activate\" && \"$REAL_HOME/.local/bin/uv\" pip install -e \"$INSTALL_DIR\""

echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð² $RUN_SCRIPT_PATH"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°
cat > "$RUN_SCRIPT_PATH" << EOF
#!/bin/bash
set -e

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd "$INSTALL_DIR"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· git pull --rebase..."
git pull --rebase

sudo -u "$REAL_USER" env PATH="$REAL_PATH" bash -c "source \"$VENV_DIR/bin/activate\" && \"$REAL_HOME/.local/bin/uv\" sync -U"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
"$VENV_DIR/bin/python" -m gion.__main__
EOF

# Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ
chmod +x "$RUN_SCRIPT_PATH"
echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½: $RUN_SCRIPT_PATH"

echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ systemd unit Ñ„Ð°Ð¹Ð» /etc/systemd/system/gion.service..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°
cat > /etc/systemd/system/gion.service << EOF
[Unit]
Description=Pion Autostart Service
After=network.target

[Service]
Type=simple
ExecStart=$RUN_SCRIPT_PATH
WorkingDirectory=$INSTALL_DIR
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
User=$REAL_USER

[Install]
WantedBy=multi-user.target
EOF

echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ..."
systemctl daemon-reload
systemctl enable gion.service
systemctl restart gion.service

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ geobot.service, ÐµÑÐ»Ð¸ Ð¾Ð½ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
if [ -f "/etc/systemd/system/geobot.service" ]; then
  echo "ðŸ”„ ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ geobot.service..."
  systemctl enable geobot.service
  systemctl restart geobot.service
else
  echo "âš ï¸ geobot.service Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸ÑŽ."
fi

echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°. Ð¡ÐµÑ€Ð²Ð¸Ñ 'gion.service' Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð¿Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ $REAL_USER."
echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð¿ÑƒÑ‚Ð¸: $RUN_SCRIPT_PATH"
